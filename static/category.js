// Generated by CoffeeScript 1.4.0
(function() {

  jQuery(function() {
    var get_more_items, simplify_url;
    get_more_items = function(start) {
      var _this = this;
      $.getJSON('', {
        ajax: 1,
        'start': start
      }, function(data) {
        var html_text, pin, _i, _len;
        for (_i = 0, _len = data.length; _i < _len; _i++) {
          pin = data[_i];
          pin['simplifiedurl'] = simplify_url(pin['link']);
          if (pin['tags'] !== null) {
            pin['taglist'] = pin['tags'].split(' ');
          }
          html_text = $.pin_template(pin);
          $('#category_column_' + $.column_control).append(html_text);
          if ($.column_control === 5) {
            $.column_control = 1;
          } else {
            $.column_control += 1;
          }
        }
      });
    };
    simplify_url = function(url) {
      var first_slash_position, simplified;
      simplified = url;
      if (simplified.indexOf('http:') === 0) {
        simplified = simplified.substring(6, simplified.length - 1);
      }
      if (simplified.indexOf('https:') === 0) {
        simplified = simplified.substring(7, simplified.length - 1);
      }
      if (simplified.indexOf('//') === 0) {
        simplified = simplified.substring(2, simplified.length - 1);
      }
      if (simplified.indexOf('/') === 0) {
        simplified = simplified.substring(1, simplified.length - 1);
      }
      first_slash_position = simplified.indexOf('/');
      if (first_slash_position > 0) {
        simplified = simplified.substring(0, first_slash_position);
      }
      return simplified;
    };
    $(window).scroll(function() {
      var doc_height, height, sensitivity, top;
      top = $(window).scrollTop();
      height = $(window).innerHeight();
      doc_height = $(document).height();
      sensitivity = 600;
      if (top + height + sensitivity > doc_height) {
        get_more_items();
      }
    });
    $(document).on('mouseenter', '.category_pin', function(event) {
      var buttons;
      event.preventDefault();
      buttons = $(this).children('.category_pins_buttons');
      buttons.css($(this).offset());
      buttons.show();
    });
    $(document).on('mouseleave', '.category_pin', function(event) {
      var buttons;
      event.preventDefault();
      buttons = $(this).children('.category_pins_buttons');
      buttons.hide();
    });
    $(document).on('click', '.category_pin_image', function(event) {
      var pinid;
      event.preventDefault();
      pinid = $(this).attr('pinid');
      $.get('/item/' + pinid + '?embed=true', function(data) {
        $('#show_pin_layer_content').html(data);
        $('#show_pin_layer').width($(document).width());
        $('#show_pin_layer').height($(document).height());
        $('#show_pin_layer').show();
      });
    });
    $('#show_pin_layer').on('click', function(event) {
      event.preventDefault();
      $(this).hide();
    });
    $('#show_pin_layer_content').on('click', function(event) {
      event.stopPropagation();
      event.stopInmediatePropagation();
    });
    $.pin_template = _.template($('#pin_template').html());
    $.column_control = 1;
    get_more_items(true);
  });

}).call(this);
