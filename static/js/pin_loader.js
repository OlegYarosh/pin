// Generated by CoffeeScript 1.4.0
(function() {

  jQuery(function() {
    var all_fields_blank, category_selected, ensure_tags_has_hash_symbol, get_pin_html_text, have_valid_price, load_more_pins, open_edit_dialog_for, price_regex, put_more_pins_into_the_page, refresh_pin, remove_all_errors, remove_error_from_field, selected_a_price_range, separate_link_to_fit_small_space, show_error_for_field, update_pin_in_backgroud, validate_errors, validate_image, validate_link_and_product;
    $("#tabs").tabs();
    $('.urllink,.imagelink,.urlproduct_url').change(function(e) {
      var i, value;
      i = $(this).attr('i');
      remove_error_from_field($(this), i);
      value = $(this).val().toLowerCase();
      if (value !== '' && value.indexOf('http://') !== 0 && value.indexOf('https://') !== 0) {
        if (value.indexOf('//') === 0) {
          $(this).val('http:' + value);
        } else {
          $(this).val('http://' + value);
        }
      }
    });
    $('.imagefile').on('change', function(e) {
      var i, value;
      i = $(this).attr('i');
      remove_error_from_field($(this), i);
      value = $(this).val().toLowerCase();
      if (value.indexOf('.png') === -1 && value.indexOf('.jpg') === -1 && value.indexOf('.jpeg') === -1 && value.indexOf('.gif') === -1 && value.indexOf('.svg') === -1) {
        show_error_for_field($(this), 'Image doesn\'t seem to be in a internet friendly format: .png, ,jpg, .gif, .svn', i);
      }
    });
    $('.titleentry').on('change', function() {
      var i;
      i = $(this).attr('i');
      if ($(this).val() !== '') {
        remove_error_from_field($(this), i);
      }
    });
    $('.prodprice').on('change', function() {
      var i;
      i = $(this).attr('i');
      have_valid_price($(this), i);
    });
    $('#form').submit(function(e) {
      var can_submit, i, no_error, _i;
      try {
        can_submit = true;
        remove_all_errors();
        for (i = _i = 1; _i <= 10; i = ++_i) {
          no_error = validate_errors(i);
          if (can_submit) {
            can_submit = no_error;
          }
        }
        if (!category_selected()) {
          can_submit = false;
        }
        if (!can_submit) {
          window.alert('Errors pending, please check');
        }
        return can_submit;
      } catch (error) {
        alert(error);
        return false;
      }
    });
    validate_errors = function(i) {
      var description, image, imageurl, link, no_error, price, product_url, tags, title;
      no_error = true;
      title = $('#title' + i);
      description = $('#description' + i);
      link = $('#link' + i);
      product_url = $('#product_url' + i);
      imageurl = $('#imageurl' + i);
      image = $('#image' + i);
      tags = $('#tags' + i);
      price = $('#price' + i);
      if (all_fields_blank(title, description, link, imageurl, image, tags, price, product_url)) {
        return no_error;
      }
      if (title.val() === '') {
        no_error = false;
        show_error_for_field(title, 'Empty title', i);
      } else {
        remove_error_from_field(title, i);
      }
      if (tags.val() === '') {
        no_error = false;
        show_error_for_field(tags, 'Empty tags', i);
      } else {
        remove_error_from_field(tags, i);
        ensure_tags_has_hash_symbol(tags);
      }
      if (!have_valid_price(price, i)) {
        no_error = false;
      }
      if (!validate_link_and_product(link, product_url, i)) {
        no_error = false;
      }
      if (!selected_a_price_range(i)) {
        no_error = false;
      }
      if (!validate_image(imageurl, image, i)) {
        no_error = false;
      }
      return no_error;
    };
    all_fields_blank = function(title, description, link, imageurl, image, tags, price, product_url) {
      return title.val() === '' && description.val() === '' && link.val() === '' && imageurl.val() === '' && tags.val() === '' && image.val() === '' && price.val() === '' && product_url.val() === '';
    };
    show_error_for_field = function(field, text, i) {
      field.addClass('field_error');
      return field.after('<div class="error_text">' + text + '</div>');
    };
    remove_error_from_field = function(field, i) {
      field.removeClass('field_error');
      return field.nextAll('.error_text').remove();
    };
    remove_all_errors = function() {
      return $('div.error_text').remove();
    };
    validate_link_and_product = function(link, product_url, i) {
      var message, value;
      remove_error_from_field(link, i);
      remove_error_from_field(product_url, i);
      if (link.val() === '' && product_url.val() === '') {
        message = 'Provide source link or product link';
        show_error_for_field(link, message, i);
        show_error_for_field(product_url, message, i);
        return false;
      } else {
        value = link.val().toLowerCase();
        if (value !== '' && value.indexOf('http://') !== 0 && value.indexOf('https://') !== 0) {
          if (value.indexOf('//') === 0) {
            link.val('http:' + value);
          } else {
            link.val('http://' + value);
          }
        }
        value = product_url.val().toLowerCase();
        if (value !== '' && value.indexOf('http://') !== 0 && value.indexOf('https://') !== 0) {
          if (value.indexOf('//') === 0) {
            product_url.val('http:' + value);
          } else {
            product_url.val('http://' + value);
          }
        }
      }
      return true;
    };
    validate_image = function(imageurl, image, i) {
      var value;
      if (imageurl.val() === '' && image.val() === '') {
        show_error_for_field(imageurl, 'Empty image', i);
        show_error_for_field(image, 'Empty image', i);
        return false;
      } else {
        remove_error_from_field(imageurl, i);
        remove_error_from_field(image, i);
        value = imageurl.val().toLowerCase();
        if (value) {
          if (value.indexOf('http://') !== 0 && value.indexOf('https://') !== 0) {
            if (value.indexOf('//') === 0) {
              $(this).val('http:' + value);
            } else {
              $(this).val('http://' + value);
            }
          }
        } else {
          value = image.val().toLowerCase();
          if (value.indexOf('.png') === -1 && value.indexOf('.jpg') === -1 && value.indexOf('.jpeg') === -1 && value.indexOf('.gif') === -1 && value.indexOf('.svg') === -1) {
            show_error_for_field(image, 'Image doesn\'t seem to be in a internet friendly format: .png, ,jpg, .gif, .svn', i);
          }
        }
      }
      return true;
    };
    ensure_tags_has_hash_symbol = function(field) {
      var new_tag, new_value, some_has_no_hash_symbol, tag, value, _i, _len, _ref;
      value = field.val();
      new_value = '';
      some_has_no_hash_symbol = false;
      _ref = value.split(" ");
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        tag = _ref[_i];
        if (tag.indexOf('#') !== 0) {
          some_has_no_hash_symbol = true;
          new_tag = '#' + tag;
        } else {
          new_tag = tag;
        }
        if (new_value === '') {
          new_value = new_tag;
        } else {
          new_value = new_value + ' ' + new_tag;
        }
      }
      if (some_has_no_hash_symbol) {
        field.val(new_value);
      }
    };
    price_regex = /^\d+(?:\.?\d{0,2})$/;
    have_valid_price = function(price, i) {
      var value;
      remove_error_from_field(price, i);
      if (price.val() === '') {
        return true;
      }
      if (price.val().indexOf('$') === 0) {
        price.val(price.val().substring(1, price.val().length));
      }
      if (!price_regex.test(price.val())) {
        show_error_for_field(price, 'Not a valid price. Use format: 8888.88', i);
        return false;
      } else {
        value = price.val();
        if (value.indexOf('.') === -1) {
          price.val(value + '.00');
        } else if (value.indexOf('.') === value.length - 1) {
          price.val(value + '00');
        } else if (value.indexOf('.') === value.length - 2) {
          price.val(value + '0');
        }
      }
      return true;
    };
    $('.tagwords').on('change', function() {
      var i;
      i = $(this).attr('i');
      remove_error_from_field($(this), i);
      if ($(this).val() !== '') {
        return ensure_tags_has_hash_symbol($(this));
      }
    });
    selected_a_price_range = function(i) {
      var price_range;
      remove_error_from_field($('#price_range' + i), i);
      price_range = $('input[name=price_range' + i + ']:checked').val();
      console.log(price_range);
      if (price_range === void 0) {
        show_error_for_field($('#price_range' + i), 'Select a price range');
        return false;
      }
      return true;
    };
    category_selected = function() {
      var c, category_value, checked_categories, value, _i, _len;
      checked_categories = $('input[name="category_check"]:checked');
      $('#category_error_message').hide();
      if (checked_categories.length > 0) {
        category_value = '';
        for (_i = 0, _len = checked_categories.length; _i < _len; _i++) {
          c = checked_categories[_i];
          value = c.value;
          if (category_value !== '' && category_value.lastIndexOf(',') !== category_value.length - 1) {
            category_value = category_value + ',';
          }
          category_value = category_value + value;
        }
        $('input[name=categories]').val(category_value);
        return true;
      } else {
        $('#category_error_message').show();
        return false;
      }
    };
    $(window).scroll(function() {
      var doc_height, height, sensitivity, top;
      top = $(window).scrollTop();
      height = $(window).innerHeight();
      doc_height = $(document).height();
      sensitivity = 300;
      if (top + height + sensitivity > doc_height) {
        load_more_pins();
      }
    });
    $.loading_more_pins = true;
    $.ajax({
      type: 'GET',
      url: '/admin/input/pins/',
      dataType: 'json',
      data: {
        'offset': '0'
      },
      cache: false,
      success: function(d) {
        put_more_pins_into_the_page(d);
      },
      error: function(x, textStatus, errorThrown) {
        $.loading_more_pins = false;
        console.log("Error:" + textStatus + ', ' + errorThrown);
      }
    });
    load_more_pins = function() {
      if (!$.loading_more_pins) {
        $.loading_more_pins = true;
        $.ajax({
          type: 'GET',
          url: '/admin/input/pins/',
          dataType: 'json',
          cache: false,
          success: function(d) {
            put_more_pins_into_the_page(d);
          },
          error: function(x, textStatus, errorThrown) {
            $.loading_more_pins = false;
            console.log("Error:" + textStatus + ', ' + errorThrown);
          }
        });
        return;
      }
    };
    $('#load_more_button').on('click', function() {
      return load_more_pins();
    });
    $.column_control = 1;
    put_more_pins_into_the_page = function(data) {
      var column, pin, _i, _len;
      for (_i = 0, _len = data.length; _i < _len; _i++) {
        pin = data[_i];
        column = $('.column' + $.column_control);
        column.append('<div class="pinbox" pinid="' + pin['id'] + '">' + get_pin_html_text(pin) + '</div>');
        $.column_control += 1;
        if ($.column_control > 4) {
          $.column_control = 1;
        }
      }
      $.loading_more_pins = false;
    };
    get_pin_html_text = function(pin) {
      var base_html, cat, html, start, _i, _len, _ref;
      start = true;
      pin['categories_list'] = '';
      _ref = pin['categories'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        cat = _ref[_i];
        if (start) {
          start = false;
        } else {
          pin['categories_list'] = pin['categories_list'] + ', ';
        }
        pin['categories_list'] = pin['categories_list'] + cat['name'];
      }
      pin['separate_product'] = separate_link_to_fit_small_space(pin['product_url']);
      pin['separate_link'] = separate_link_to_fit_small_space(pin['link']);
      base_html = $('#pin_template').html();
      html = _.template(base_html, pin);
      return html;
    };
    $('body').on('click', '.button_pin_delete', function() {
      var confirmation, pinid;
      confirmation = window.confirm('Are you sure to delete this pin?');
      if (confirmation) {
        pinid = $(this).attr('pinid');
        $.ajax({
          type: 'DELETE',
          url: '/admin/input/pins/' + pinid + '/'
        });
        $('div.pinbox[pinid="' + pinid + '"]').remove();
      }
    });
    $('#pin_edit_dialog').dialog({
      autoOpen: false,
      minWidth: 500
    });
    $('body').on('click', '.button_pin_edit', function() {
      var pinid;
      pinid = $(this).attr('pinid');
      $.ajax({
        type: 'GET',
        url: '/admin/input/pins/' + pinid + '/',
        dataType: 'json',
        cache: false,
        success: function(pin) {
          open_edit_dialog_for(pin);
        },
        error: function(x, textStatus, errorThrown) {
          $.loading_more_pins = false;
          console.log("Error:" + textStatus + ', ' + errorThrown);
        }
      });
    });
    open_edit_dialog_for = function(pin) {
      $("#id11").val(pin['id']);
      $("#title11").val(pin['name']);
      $("#description11").val(pin['description']);
      $("#link11").val(pin['link']);
      $("#product_url11").val(pin['product_url']);
      $("#tags11").val(pin['tags']);
      $("#imgtag11").attr('src', '/static/tmp/pinthumb' + pin['id'] + '.png?_=' + new Date().getTime());
      $("#imgfulllink11").attr('href', '/pin/' + pin['id']);
      $("#category11").val(pin['category']);
      $("#imageurl11").val('');
      $("#image11").val('');
      if (pin['price'] !== 'None') {
        $("#price11").val(pin['price']);
      } else {
        $("#price11").val('');
      }
      $("#previmageurl11").attr('href', pin['image_url']);
      $('input[name=price_range11]').prop('checked', false);
      $('input[name=price_range11][value=' + pin['price_range'] + ']').prop('checked', true);
      remove_all_errors();
      return $('#pin_edit_dialog').dialog('open');
    };
    $('#pin_edit_form').submit(function() {
      var category, description, image, imageurl, link, no_error, pinid, price, price_range, product_url, tags, title;
      no_error = true;
      pinid = $('#id11');
      title = $('#title11');
      description = $('#description11');
      link = $('#link11');
      product_url = $('#product_url11');
      imageurl = $('#imageurl11');
      image = $('#image11');
      tags = $('#tags11');
      category = $('#category11');
      price = $('#price11');
      price_range = $('input[name=price_range11]:checked');
      if (title.val() === '') {
        no_error = false;
        show_error_for_field(title, 'Empty title', 11);
      } else {
        remove_error_from_field(title, 11);
      }
      if (tags.val() === '') {
        no_error = false;
        show_error_for_field(tags, 'Empty tags', 11);
      } else {
        remove_error_from_field(tags, 11);
        ensure_tags_has_hash_symbol(tags);
      }
      if (!have_valid_price(price, 11)) {
        no_error = false;
      }
      if (!validate_link_and_product(link, product_url, 11)) {
        no_error = false;
      }
      if (!selected_a_price_range(11)) {
        no_error = false;
      }
      if (no_error) {
        if (image.val() !== '' && imageurl.val() === '') {
          return true;
        } else {
          update_pin_in_backgroud(pinid, title, description, link, product_url, imageurl, tags, category, price, price_range);
          $('#pin_edit_dialog').dialog('close');
        }
      }
      return false;
    });
    update_pin_in_backgroud = function(pinid, title, description, link, product_url, imageurl, tags, category, price, price_range) {
      var pin_data;
      pin_data = {
        'title': title.val(),
        'description': description.val(),
        'link': link.val(),
        'product_url': product_url.val(),
        'imageurl': imageurl.val(),
        'tags': tags.val(),
        'category': category.val(),
        'price': price.val(),
        'price_range': price_range.val()
      };
      $.ajax({
        type: 'POST',
        url: '/admin/input/pins/' + pinid.val() + '/',
        data: pin_data,
        dataType: 'json',
        cache: false,
        success: function(data) {
          if (data['status'] !== 'ok') {
            return window.alert('Server error in your last update: ' + data['status']);
          } else {
            return refresh_pin(pinid.val());
          }
        },
        error: function(x, err, ex) {
          return window.alert('Server error in your last update: ' + err + ' ' + ex);
        }
      });
    };
    refresh_pin = function(pin_id) {
      $.ajax({
        type: 'GET',
        url: '/admin/input/pins/' + pin_id + '/',
        dataType: 'json',
        cache: false,
        success: function(pin) {
          var box, text;
          box = $('div.pinbox[pinid="' + pin_id + '"]');
          text = get_pin_html_text(pin);
          box.html(text);
        },
        error: function(x, textStatus, errorThrown) {
          console.log("Error:" + textStatus + ', ' + errorThrown);
        }
      });
    };
    separate_link_to_fit_small_space = function(url) {
      var i, last_val, sep, slice, _i, _ref;
      sep = Array();
      last_val = 0;
      for (i = _i = 0, _ref = url.length; _i <= _ref; i = _i += 16) {
        last_val = i;
        slice = url.slice(i, i + 16);
        sep.push(slice);
      }
      return sep.join(' ');
    };
  });

}).call(this);
