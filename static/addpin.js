// Generated by CoffeeScript 1.7.1
(function() {
  var images, preview;

  preview = $('<div/>').addClass('preview');

  preview.insertAfter($('#input-url'));

  images = [];

  window.imagesLoading = false;

  $('#input-url').blur(function() {
    var url;
    url = $(this).val();
    $('#input-link').val(url);
    if (url.replace('https://', '').replace('http://', '').indexOf('/') === -1) {
      url += '/';
    }
    window.imagesLoading = true;
    preview.html('loading images&hellip;');
    $('#btn-add').prop('disabled', true);
    return $.getJSON('/preview?url=' + url, function(data) {
      var counter, first, img, src, _i, _len, _ref;
      $('#btn-add').prop('disabled', false);
      preview.html('');
      if ('title' in data) {
        $('#input-desc').val(data.title);
      }
      if ('images' in data) {
        first = true;
        counter = 0;
        preview.html('<h4>Choose an image:</h4>');
        images = [];
        _ref = data.images;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          src = _ref[_i];
          images.push(src);
          if (first) {
            img = $('<img/>').attr('src', src).attr('id', counter++).addClass('selected');
            window.selected = src + ',';
            first = false;
          } else {
            img = $('<img/>').attr('src', src).attr('id', counter++);
          }
          preview.append(img);
          img.click(function() {
            src = images[parseInt($(this).attr('id'))];
            if ($(this).hasClass('selected')) {
              $(this).removeClass('selected');
              return window.selected.replace(new RegExp(src + ','), '');
            } else {
              window.selected += src + ',';
              return $(this).addClass('selected');
            }
          });
        }
      }
      return window.imagesLoading = false;
    });
  });

  $('#form').submit(function() {
    if (window.imagesLoading) {
      alert("Please wait for all images to load.");
      return false;
    }
    if (window.selected) {
      $('#input-url').val(window.selected);
    }
    return true;
  });

}).call(this);
